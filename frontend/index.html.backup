<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SoundSense ‚Äî Integrated Dashboard</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f172a;
      --card:#ffffff;
      --text:#0b1220;
      --muted:#6b7280;
      --border:#e5e7eb;
      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --info:#3b82f6;
      --shadow: 0 10px 24px rgba(2, 6, 23, .10);
      --radius: 16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:linear-gradient(180deg, #0b1220 0%, #0b1220 240px, #f6f7fb 240px, #f6f7fb 100%);
    }

    header{ padding:18px 20px; color:#fff; }
    .wrap{ max-width: 1400px; margin: 0 auto; }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
    }

    .brand{ display:flex; flex-direction:column; gap:4px; }
    .brand h1{ margin:0; font-size:18px; letter-spacing:.2px; }
    .brand p{ margin:0; font-size:12px; color:rgba(255,255,255,.78); }

    .tabs {
      display:flex;
      gap:8px;
    }
    .tabs button {
      padding:8px 16px;
      border-radius:999px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      color:#fff;
      font-weight:700;
      font-size:12px;
      cursor:pointer;
      transition:all 0.2s;
    }
    .tabs button:hover {
      background:rgba(255,255,255,.15);
    }
    .tabs button.active {
      background:rgba(255,255,255,.95);
      color:#0b1220;
    }

    .status{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:999px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      font-weight:700;
      font-size:13px;
      white-space:nowrap;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background:var(--warn);
      box-shadow:0 0 0 4px rgba(245,158,11,.18);
    }
    .dot.ok{ background:var(--ok); box-shadow:0 0 0 4px rgba(22,163,74,.18); }
    .dot.bad{ background:var(--bad); box-shadow:0 0 0 4px rgba(239,68,68,.18); }

    main{ padding: 18px 20px 34px; }

    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:16px;
      align-items:stretch;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
    }

    .stats-grid {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap:12px;
      margin-top:12px;
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:20px;
    }

    .card-header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:16px;
    }

    .title{ font-weight:900; font-size:16px; letter-spacing:.2px; }
    .sub{ color:var(--muted); font-size:12px; margin-top:4px; line-height:1.35; }

    .big{
      display:flex;
      align-items:baseline;
      gap:10px;
      margin-top:8px;
    }
    .big .value{
      font-size:54px;
      font-weight:950;
      letter-spacing:-1px;
      line-height:1;
    }
    .big .unit{
      font-size:14px;
      color:var(--muted);
      font-weight:800;
    }

    .stat{
      border:1px solid var(--border);
      border-radius:12px;
      padding:14px;
      background:#fafafa;
    }
    .stat .label{ font-size:11px; color:var(--muted); font-weight:800; margin-bottom:6px; text-transform:uppercase; letter-spacing:.3px; }
    .stat .value{ font-weight:950; font-size:24px; letter-spacing:-.5px; }
    .stat .unit{ font-size:12px; color:var(--muted); margin-left:4px; }

    .pill{
      padding:6px 12px;
      border-radius:999px;
      font-size:11px;
      font-weight:900;
      border:1px solid var(--border);
      background:#f8fafc;
      color:#111827;
      white-space:nowrap;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .pill.quiet{ background:rgba(22,163,74,.10); border-color:rgba(22,163,74,.25); color:#15803d; }
    .pill.normal{ background:rgba(59,130,246,.10); border-color:rgba(59,130,246,.25); color:#1d4ed8; }
    .pill.moderate{ background:rgba(245,158,11,.12); border-color:rgba(245,158,11,.28); color:#b45309; }
    .pill.loud{ background:rgba(239,68,68,.10); border-color:rgba(239,68,68,.25); color:#dc2626; }
    .pill.concerning{ background:rgba(220,38,38,.15); border-color:rgba(220,38,38,.3); color:#991b1b; }

    .kpi-row{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .kpi{
      flex:1;
      min-width:180px;
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background:#fafafa;
    }
    .kpi .k{ font-size:12px; color:var(--muted); font-weight:800; margin-bottom:6px; }
    .kpi .v{ font-weight:950; font-size:18px; letter-spacing:-.2px; }

    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px 14px;
      align-items:center;
      margin-top:10px;
      padding-top:10px;
      border-top:1px dashed var(--border);
    }

    label{
      font-size:12px;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:8px;
    }
    input[type="checkbox"]{ transform: translateY(1px); }
    input[type="range"]{ width:220px; accent-color:#111827; }

    .summary-section {
      background:#f8fafc;
      border:1px solid var(--border);
      border-radius:12px;
      padding:16px;
      margin-top:16px;
    }
    .summary-section h3 {
      margin:0 0 12px 0;
      font-size:13px;
      font-weight:900;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.4px;
    }
    .summary-section p {
      margin:8px 0;
      line-height:1.6;
      font-size:14px;
    }

    table {
      width:100%;
      border-collapse:collapse;
      margin-top:12px;
      font-size:13px;
    }
    th {
      background:#f1f5f9;
      padding:10px 12px;
      text-align:left;
      font-weight:900;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.3px;
      color:var(--muted);
      border-bottom:2px solid var(--border);
    }
    td {
      padding:12px;
      border-bottom:1px solid #f1f5f9;
    }
    tr:hover td {
      background:#fafafa;
    }

    .btn{
      cursor:pointer;
      border:1px solid var(--border);
      background:#111827;
      color:#fff;
      font-weight:900;
      font-size:12px;
      padding:10px 16px;
      border-radius:12px;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .btn:hover{ background:#1f2937; }
    .btn:active{ transform:translateY(1px); }
    .btn.secondary{
      background:#fff;
      color:#111827;
    }
    .btn.secondary:hover{ background:#f8fafc; }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .loading {
      display:inline-block;
      width:16px;
      height:16px;
      border:2px solid #f3f4f6;
      border-top-color:#111827;
      border-radius:50%;
      animation:spin 0.6s linear infinite;
    }
    @keyframes spin {
      to { transform:rotate(360deg); }
    }

    .alert {
      padding:12px 16px;
      border-radius:12px;
      margin-top:12px;
      font-size:13px;
      line-height:1.5;
    }
    .alert.info {
      background:rgba(59,130,246,.10);
      border:1px solid rgba(59,130,246,.25);
      color:#1e40af;
    }
    .alert.warn {
      background:rgba(245,158,11,.10);
      border:1px solid rgba(245,158,11,.25);
      color:#b45309;
    }
    .alert.error {
      background:rgba(239,68,68,.10);
      border:1px solid rgba(239,68,68,.25);
      color:#dc2626;
    }

    .empty-state {
      text-align:center;
      padding:40px 20px;
      color:var(--muted);
    }

    code {
      font-family:var(--mono);
      font-size:11px;
      background:#f1f5f9;
      padding:2px 6px;
      border-radius:6px;
      border:1px solid #e2e8f0;
    }

    pre{
      margin:0;
      padding:12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#0b1220;
      color:#e5e7eb;
      font-size:12px;
      overflow:auto;
      max-height:340px;
      white-space:pre-wrap;
      word-break:break-word;
      font-family: var(--mono);
    }

    .chart-card{ margin-top:16px; }
    svg{ width:100%; height:320px; display:block; }
    .mono {
      font-family:var(--mono);
      font-size:12px;
    }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="topbar">
        <div class="brand">
          <h1>SoundSense</h1>
          <p>ML-Powered Sound Monitoring with FHIR Integration</p>
        </div>

        <div class="tabs">
          <button id="tabLive" class="active" onclick="switchTab('live')">üìä Live Stream</button>
          <button id="tabAI" onclick="switchTab('ai')">ü§ñ AI Analysis</button>
          <button id="tabData" onclick="switchTab('data')">üìã Data</button>
        </div>

        <div class="status" title="WebSocket connection status">
          <span id="dot" class="dot"></span>
          <span id="statusText">Connecting‚Ä¶</span>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap">
      <!-- Live Stream Tab -->
      <div id="contentLive" class="tab-content active">
        <div class="grid">
          <!-- Current Sound -->
          <section class="card">
            <div class="card-header">
              <div>
                <div class="title">Current Sound</div>
                <div class="sub">Live updates from <code>ws://localhost:8080/ws/live</code></div>
              </div>
              <div id="levelPill" class="pill">‚Äî</div>
            </div>

            <div class="big">
              <div id="current" class="value">‚Äî</div>
              <div class="unit">AU</div>
            </div>

            <div class="kpi-row">
              <div class="kpi">
                <div class="k">Last 60 samples (min)</div>
                <div class="v" id="min60">‚Äî</div>
              </div>
              <div class="kpi">
                <div class="k">Last 60 samples (max)</div>
                <div class="v" id="max60">‚Äî</div>
              </div>
              <div class="kpi">
                <div class="k">Last 60 samples (avg)</div>
                <div class="v" id="avg60">‚Äî</div>
              </div>
            </div>

            <div class="controls">
              <label>
                <input type="checkbox" id="autoZoom" checked />
                Auto-zoom Y axis
              </label>

              <label title="Only used when auto-zoom is ON">
                Zoom padding
                <input type="range" id="pad" min="2" max="40" value="8" />
                <span id="padVal" style="min-width:28px; display:inline-block; text-align:right;">8</span>
              </label>

              <label title="If auto-zoom is OFF, Y axis uses this fixed range centered on latest value">
                Fixed Y range
                <input type="range" id="fixedRange" min="30" max="400" value="80" />
                <span id="fixedVal" style="min-width:40px; display:inline-block; text-align:right;">80</span>
              </label>
            </div>
          </section>

          <!-- Last FHIR Observation -->
          <section class="card">
            <div class="card-header">
              <div>
                <div class="title">Last FHIR Observation</div>
                <div class="sub">Most recent message received over WebSocket</div>
              </div>
            </div>
            <pre id="last">Waiting for data‚Ä¶</pre>
          </section>
        </div>

        <!-- Live Chart -->
        <section class="card chart-card">
          <div class="card-header">
            <div>
              <div class="title">Live chart (last 60 samples)</div>
              <div class="sub">D3.js real-time visualization of sound levels</div>
            </div>
          </div>
          <svg id="chart" aria-label="Sound chart"></svg>
        </section>
      </div>

      <!-- AI Analysis Tab -->
      <div id="contentAI" class="tab-content">
        <!-- AI-Generated Summary -->
        <section class="card">
          <div class="card-header">
            <div>
              <div class="title">ü§ñ AI-Generated Analysis</div>
              <div class="sub">Machine learning insights and anomaly detection</div>
            </div>
            <button id="refreshML" class="btn secondary">
              <span id="mlLoadIcon"></span>
              Refresh Analysis
            </button>
          </div>

          <div id="mlContent">
            <div class="alert info">
              Click "Refresh Analysis" to get ML-powered insights from your sensor data.
            </div>
          </div>
        </section>

        <!-- Statistics Overview -->
        <section class="card">
          <div class="card-header">
            <div>
              <div class="title">üìä Database Statistics</div>
              <div class="sub">Overall system metrics from PostgreSQL</div>
            </div>
            <button id="refreshStats" class="btn secondary">
              <span id="statsLoadIcon"></span>
              Refresh Stats
            </button>
          </div>

          <div class="stats-grid" id="statsGrid">
            <div class="stat">
              <div class="label">Total Readings</div>
              <div class="value" id="totalReadings">‚Äî</div>
            </div>
            <div class="stat">
              <div class="label">Unique Patients</div>
              <div class="value" id="uniquePatients">‚Äî</div>
            </div>
            <div class="stat">
              <div class="label">Unique Devices</div>
              <div class="value" id="uniqueDevices">‚Äî</div>
            </div>
            <div class="stat">
              <div class="label">Avg Sound Level</div>
              <div class="value" id="avgValue">‚Äî</div>
              <span class="unit">AU</span>
            </div>
            <div class="stat">
              <div class="label">Min Recorded</div>
              <div class="value" id="minValue">‚Äî</div>
              <span class="unit">AU</span>
            </div>
            <div class="stat">
              <div class="label">Max Recorded</div>
              <div class="value" id="maxValue">‚Äî</div>
              <span class="unit">AU</span>
            </div>
          </div>

          <div id="statsAlert"></div>
        </section>
      </div>

      <!-- Data Tab -->
      <div id="contentData" class="tab-content">
        <section class="card">
          <div class="card-header">
            <div>
              <div class="title">üìã Recent Observations</div>
              <div class="sub">Last 20 FHIR observations from the database</div>
            </div>
            <button id="refreshTable" class="btn secondary">
              <span id="tableLoadIcon"></span>
              Refresh Data
            </button>
          </div>

          <div id="tableContent">
            <div class="alert info">
              Click "Refresh Data" to load recent sensor readings.
            </div>
          </div>
        </section>
      </div>
    </div>
  </main>

<script>
  const BACKEND = `http://${location.hostname || 'localhost'}:8080`;
  const ML_SERVICE = `http://${location.hostname || 'localhost'}:8000`;
  const WS_URL = `ws://${location.hostname || 'localhost'}:8080/ws/live`;

  // Tab switching
  function switchTab(tab) {
    // Hide all tabs
    document.getElementById('contentLive').classList.remove('active');
    document.getElementById('contentAI').classList.remove('active');
    document.getElementById('contentData').classList.remove('active');

    // Deactivate all tab buttons
    document.getElementById('tabLive').classList.remove('active');
    document.getElementById('tabAI').classList.remove('active');
    document.getElementById('tabData').classList.remove('active');

    // Show selected tab
    if (tab === 'live') {
      document.getElementById('contentLive').classList.add('active');
      document.getElementById('tabLive').classList.add('active');
    } else if (tab === 'ai') {
      document.getElementById('contentAI').classList.add('active');
      document.getElementById('tabAI').classList.add('active');
      // Auto-load data when switching to AI tab
      if (!aiDataLoaded) {
        loadStats();
        aiDataLoaded = true;
      }
    } else if (tab === 'data') {
      document.getElementById('contentData').classList.add('active');
      document.getElementById('tabData').classList.add('active');
      // Auto-load data when switching to Data tab
      if (!dataTableLoaded) {
        loadTable();
        dataTableLoaded = true;
      }
    }
  }

  let aiDataLoaded = false;
  let dataTableLoaded = false;

  // JWT Token Management
  let authToken = localStorage.getItem('jwt_token');

  async function login() {
    try {
      const response = await fetch(`${BACKEND}/auth/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: 'admin', password: 'admin123' })
      });
      
      if (response.ok) {
        const data = await response.json();
        authToken = data.token;
        localStorage.setItem('jwt_token', authToken);
        return true;
      }
    } catch (error) {
      console.error('Login failed:', error);
    }
    return false;
  }

  async function fetchWithAuth(url, options = {}) {
    if (!authToken) {
      await login();
    }

    const headers = {
      ...options.headers,
      'Authorization': `Bearer ${authToken}`
    };

    let response = await fetch(url, { ...options, headers });

    // Retry once if unauthorized
    if (response.status === 401) {
      await login();
      headers.Authorization = `Bearer ${authToken}`;
      response = await fetch(url, { ...options, headers });
    }

    return response;
  }

  // Load ML Analysis
  async function loadMLAnalysis() {
    const btn = document.getElementById('refreshML');
    const icon = document.getElementById('mlLoadIcon');
    const content = document.getElementById('mlContent');

    icon.className = 'loading';
    btn.disabled = true;

    try {
      const response = await fetch(`${ML_SERVICE}/analysis`);
      
      if (!response.ok) throw new Error('ML service unavailable');

      const data = await response.json();
      
      let html = '';

      // Overall Summary
      if (data.summary) {
        html += `<div class="summary-section">
          <h3>üìà Overall Summary</h3>
          <p><strong>Total Samples:</strong> ${data.summary.total_samples || 0}</p>
          <p><strong>Time Range:</strong> ${data.summary.time_range || 'N/A'}</p>
          <p><strong>Average Level:</strong> ${(data.summary.avg_value || 0).toFixed(1)} AU</p>
          <p><strong>Standard Deviation:</strong> ${(data.summary.std_value || 0).toFixed(1)} AU</p>
        </div>`;
      }

      // Classifications
      if (data.classifications && data.classifications.length > 0) {
        html += `<div class="summary-section">
          <h3>üéØ Sound Classifications</h3>
          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">`;
        
        data.classifications.forEach(cls => {
          const className = cls.category.toLowerCase().replace(' ', '-');
          html += `<span class="pill ${className}">
            ${cls.category}: ${cls.count} (${cls.percentage.toFixed(1)}%)
          </span>`;
        });
        
        html += `</div></div>`;
      }

      // Anomalies
      if (data.anomalies && data.anomalies.detected > 0) {
        html += `<div class="alert warn">
          <strong>‚ö†Ô∏è Anomalies Detected:</strong> ${data.anomalies.detected} unusual readings found 
          (${data.anomalies.percentage.toFixed(1)}% of total)
        </div>`;
      }

      // Trends
      if (data.trends) {
        html += `<div class="summary-section">
          <h3>üìä Trends & Patterns</h3>
          <p>${data.trends.description || 'Stable sound levels detected.'}</p>
          ${data.trends.recommendation ? `<p><strong>Recommendation:</strong> ${data.trends.recommendation}</p>` : ''}
        </div>`;
      }

      // No Data State
      if (!data.summary || data.summary.total_samples === 0) {
        html = `<div class="empty-state">
          <p>No data available for analysis.</p>
          <p style="font-size:12px; margin-top:8px;">Start collecting sensor readings to see ML insights.</p>
        </div>`;
      }

      content.innerHTML = html;

    } catch (error) {
      content.innerHTML = `<div class="alert error">
        <strong>Error:</strong> ${error.message}<br>
        Make sure the ML service is running at <code>${ML_SERVICE}</code>
      </div>`;
    } finally {
      icon.className = '';
      btn.disabled = false;
    }
  }

  // Load Database Statistics
  async function loadStats() {
    const btn = document.getElementById('refreshStats');
    const icon = document.getElementById('statsLoadIcon');
    const alert = document.getElementById('statsAlert');

    icon.className = 'loading';
    btn.disabled = true;
    alert.innerHTML = '';

    try {
      const response = await fetch(`${ML_SERVICE}/stats`);
      
      if (!response.ok) throw new Error('Failed to load statistics');

      const data = await response.json();

      document.getElementById('totalReadings').textContent = data.total_readings || 0;
      document.getElementById('uniquePatients').textContent = data.unique_patients || 0;
      document.getElementById('uniqueDevices').textContent = data.unique_devices || 0;
      document.getElementById('avgValue').textContent = (data.avg_value || 0).toFixed(1);
      document.getElementById('minValue').textContent = (data.min_value || 0).toFixed(0);
      document.getElementById('maxValue').textContent = (data.max_value || 0).toFixed(0);

      if (data.total_readings === 0) {
        alert.innerHTML = `<div class="alert info">
          No readings in database yet. The simulator should start generating data shortly.
        </div>`;
      }

    } catch (error) {
      alert.innerHTML = `<div class="alert error">
        <strong>Error:</strong> ${error.message}
      </div>`;
    } finally {
      icon.className = '';
      btn.disabled = false;
    }
  }

  // Load Recent Readings Table
  async function loadTable() {
    const btn = document.getElementById('refreshTable');
    const icon = document.getElementById('tableLoadIcon');
    const content = document.getElementById('tableContent');

    icon.className = 'loading';
    btn.disabled = true;

    try {
      const response = await fetchWithAuth(`${BACKEND}/api/fhir/Observation?limit=20`);
      
      if (!response.ok) throw new Error(`HTTP ${response.status}`);

      const bundle = await response.json();
      const entries = bundle.entry || [];

      if (entries.length === 0) {
        content.innerHTML = `<div class="empty-state">
          <p>No observations found.</p>
          <p style="font-size:12px; margin-top:8px;">Sensor readings will appear here once data is collected.</p>
        </div>`;
        return;
      }

      let html = `<table>
        <thead>
          <tr>
            <th>Timestamp</th>
            <th>Patient ID</th>
            <th>Device ID</th>
            <th>Code</th>
            <th>Value</th>
            <th>Classification</th>
          </tr>
        </thead>
        <tbody>`;

      entries.forEach(entry => {
        const obs = entry.resource;
        const time = new Date(obs.effectiveDateTime).toLocaleString();
        const patientId = obs.subject?.reference?.split('/')[1] || 'N/A';
        const deviceId = obs.device?.reference?.split('/')[1] || 'N/A';
        const code = obs.code?.coding?.[0]?.code || 'N/A';
        const value = obs.valueQuantity?.value || 0;
        const unit = obs.valueQuantity?.unit || 'AU';

        // Classify value
        let classification = 'normal';
        let classText = 'Normal';
        if (value < 187) {
          classification = 'quiet';
          classText = 'Quiet';
        } else if (value >= 300 && value < 500) {
          classification = 'moderate';
          classText = 'Moderate';
        } else if (value >= 500 && value < 700) {
          classification = 'loud';
          classText = 'Loud';
        } else if (value >= 700) {
          classification = 'concerning';
          classText = 'Concerning';
        }

        html += `<tr>
          <td class="mono">${time}</td>
          <td class="mono">${patientId}</td>
          <td class="mono">${deviceId}</td>
          <td>${code}</td>
          <td><strong>${value.toFixed(1)}</strong> ${unit}</td>
          <td><span class="pill ${classification}">${classText}</span></td>
        </tr>`;
      });

      html += `</tbody></table>`;
      content.innerHTML = html;

    } catch (error) {
      content.innerHTML = `<div class="alert error">
        <strong>Error:</strong> ${error.message}<br>
        Make sure you're authenticated and the backend is running.
      </div>`;
    } finally {
      icon.className = '';
      btn.disabled = false;
    }
  }

  // Event Listeners for AI/Data tabs
  document.getElementById('refreshML').addEventListener('click', loadMLAnalysis);
  document.getElementById('refreshStats').addEventListener('click', loadStats);
  document.getElementById('refreshTable').addEventListener('click', loadTable);

  // ===== LIVE STREAM TAB - WebSocket & D3.js Chart =====

  const statusText = document.getElementById("statusText");
  const dot = document.getElementById("dot");
  const currentEl = document.getElementById("current");
  const lastEl = document.getElementById("last");
  const levelPill = document.getElementById("levelPill");
  const min60El = document.getElementById("min60");
  const max60El = document.getElementById("max60");
  const avg60El = document.getElementById("avg60");
  const autoZoomEl = document.getElementById("autoZoom");
  const padEl = document.getElementById("pad");
  const padValEl = document.getElementById("padVal");
  const fixedRangeEl = document.getElementById("fixedRange");
  const fixedValEl = document.getElementById("fixedVal");

  padValEl.textContent = padEl.value;
  fixedValEl.textContent = fixedRangeEl.value;

  padEl.addEventListener("input", () => { padValEl.textContent = padEl.value; render(); });
  fixedRangeEl.addEventListener("input", () => { fixedValEl.textContent = fixedRangeEl.value; render(); });
  autoZoomEl.addEventListener("change", render);

  // Data buffer
  const data = [];
  const maxN = 60;

  // Thresholds for the label pill
  const QUIET_MAX = 187;
  const NORMAL_MAX = 300;
  const MODERATE_MAX = 500;
  const LOUD_MAX = 700;

  function setStatus(state){
    if(state === "ok"){
      statusText.textContent = "Connected ‚úÖ";
      dot.className = "dot ok";
      return;
    }
    if(state === "bad"){
      statusText.textContent = "Disconnected ‚Äî retrying‚Ä¶";
      dot.className = "dot bad";
      return;
    }
    statusText.textContent = "Connecting‚Ä¶";
    dot.className = "dot";
  }

  function updateKpis(){
    if(data.length === 0){
      min60El.textContent = "‚Äî";
      max60El.textContent = "‚Äî";
      avg60El.textContent = "‚Äî";
      return;
    }
    const vals = data.map(d => d.value);
    const minV = Math.min(...vals);
    const maxV = Math.max(...vals);
    const avgV = vals.reduce((a,b)=>a+b,0) / vals.length;

    min60El.textContent = minV.toFixed(0) + " AU";
    max60El.textContent = maxV.toFixed(0) + " AU";
    avg60El.textContent = avgV.toFixed(1) + " AU";
  }

  function updateLevelPill(v){
    levelPill.className = "pill";
    if(v < QUIET_MAX){
      levelPill.textContent = "QUIET";
      levelPill.classList.add("quiet");
    } else if(v < NORMAL_MAX){
      levelPill.textContent = "NORMAL";
      levelPill.classList.add("normal");
    } else if(v < MODERATE_MAX){
      levelPill.textContent = "MODERATE";
      levelPill.classList.add("moderate");
    } else if(v < LOUD_MAX){
      levelPill.textContent = "LOUD";
      levelPill.classList.add("loud");
    } else {
      levelPill.textContent = "CONCERNING";
      levelPill.classList.add("concerning");
    }
  }

  // Chart setup
  const svg = d3.select("#chart");
  const margin = { top: 18, right: 18, bottom: 34, left: 56 };

  const rootG = svg.append("g");
  const xAxisG = rootG.append("g");
  const yAxisG = rootG.append("g");
  const gridG  = rootG.append("g").attr("opacity", 0.25);

  const linePath = rootG.append("path")
    .attr("fill", "none")
    .attr("stroke", "#111827")
    .attr("stroke-width", 2.25);

  const dotsG = rootG.append("g");

  const tooltip = rootG.append("g").style("display", "none");
  tooltip.append("circle").attr("r", 5).attr("fill", "#111827");
  const tipText = tooltip.append("text")
    .attr("y", -10)
    .attr("text-anchor", "middle")
    .attr("font-size", 12)
    .attr("font-weight", 900)
    .attr("fill", "#111827");

  function render(){
    const node = svg.node();
    const width = node.clientWidth || 900;
    const height = node.clientHeight || 320;

    const innerW = width - margin.left - margin.right;
    const innerH = height - margin.top - margin.bottom;

    rootG.attr("transform", `translate(${margin.left},${margin.top})`);

    const x = d3.scaleLinear()
      .domain([0, Math.max(1, data.length - 1)])
      .range([0, innerW]);

    let yMin = 0, yMax = 1;

    if(data.length > 0){
      const vals = data.map(d => d.value);
      const minV = d3.min(vals);
      const maxV = d3.max(vals);

      if(autoZoomEl.checked){
        const pad = Number(padEl.value);
        yMin = (minV ?? 0) - pad;
        yMax = (maxV ?? 1) + pad;
      } else {
        const last = vals[vals.length - 1] ?? 0;
        const half = Number(fixedRangeEl.value) / 2;
        yMin = last - half;
        yMax = last + half;
      }
    }

    if(yMax - yMin < 1){ yMin -= 1; yMax += 1; }

    const y = d3.scaleLinear()
      .domain([yMin, yMax])
      .nice()
      .range([innerH, 0]);

    xAxisG
      .attr("transform", `translate(0,${innerH})`)
      .call(d3.axisBottom(x).ticks(6).tickSizeOuter(0));

    yAxisG
      .call(d3.axisLeft(y).ticks(6).tickSizeOuter(0));

    gridG.selectAll("*").remove();
    gridG.selectAll("line")
      .data(y.ticks(6))
      .enter()
      .append("line")
      .attr("x1", 0)
      .attr("x2", innerW)
      .attr("y1", d => y(d))
      .attr("y2", d => y(d))
      .attr("stroke", "#111827");

    const line = d3.line()
      .x((d,i) => x(i))
      .y(d => y(d.value))
      .curve(d3.curveMonotoneX);

    linePath.datum(data).attr("d", line);

    const dots = dotsG.selectAll("circle").data(data, (d,i)=>i);
    dots.exit().remove();
    dots.enter()
      .append("circle")
      .attr("r", 3)
      .attr("fill", "#111827")
      .attr("opacity", 0.75)
      .merge(dots)
      .attr("cx", (d,i) => x(i))
      .attr("cy", d => y(d.value));

    svg.on("mousemove", (event) => {
      if(data.length === 0) return;
      const [mx] = d3.pointer(event, rootG.node());
      const i = Math.round(x.invert(mx));
      const idx = Math.max(0, Math.min(data.length - 1, i));
      const d = data[idx];

      tooltip.style("display", null)
        .attr("transform", `translate(${x(idx)},${y(d.value)})`);

      tipText.text(`${d.value.toFixed(0)} AU`);
    });

    svg.on("mouseleave", () => tooltip.style("display", "none"));
  }

  window.addEventListener("resize", render);

  // WebSocket connection
  let ws = null;

  function connect(){
    setStatus("connecting");

    try{
      if(ws){ ws.close(); ws = null; }
    }catch(_){}

    ws = new WebSocket(WS_URL);

    ws.onopen = () => setStatus("ok");
    ws.onclose = () => { setStatus("bad"); setTimeout(connect, 1200); };
    ws.onerror = () => { setStatus("bad"); };

    ws.onmessage = (ev) => {
      try{
        const obs = JSON.parse(ev.data);
        const v = obs?.valueQuantity?.value;

        if(typeof v === "number"){
          currentEl.textContent = v.toFixed(0);
          updateLevelPill(v);
          lastEl.textContent = JSON.stringify(obs, null, 2);

          data.push({ value: v, ts: Date.now() });
          if(data.length > maxN) data.shift();

          updateKpis();
          render();
        }
      }catch(_){}
    };
  }

  // Start WebSocket and initial render
  connect();
  render();
</script>
</body>
</html>
