<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SoundSense ‚Äî Integrated Dashboard</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f172a;
      --card:#ffffff;
      --text:#0b1220;
      --muted:#6b7280;
      --border:#e5e7eb;
      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --info:#3b82f6;
      --shadow: 0 10px 24px rgba(2, 6, 23, .10);
      --radius: 16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:linear-gradient(180deg, #0b1220 0%, #0b1220 280px, #f6f7fb 280px, #f6f7fb 100%);
    }

    header{ padding:18px 20px; color:#fff; }
    .wrap{ max-width: 1400px; margin: 0 auto; }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
    }

    .brand{ display:flex; flex-direction:column; gap:4px; }
    .brand h1{ margin:0; font-size:20px; letter-spacing:.2px; }
    .brand p{ margin:0; font-size:12px; color:rgba(255,255,255,.78); }

    .tabs{
      display:flex;
      gap:8px;
      background:rgba(255,255,255,.06);
      padding:4px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.1);
    }
    .tab{
      padding:8px 16px;
      border-radius:8px;
      font-weight:800;
      font-size:12px;
      cursor:pointer;
      color:rgba(255,255,255,.7);
      transition:all .2s;
      border:none;
      background:transparent;
    }
    .tab:hover{
      color:rgba(255,255,255,.9);
      background:rgba(255,255,255,.08);
    }
    .tab.active{
      background:#fff;
      color:#0b1220;
      box-shadow:0 2px 8px rgba(0,0,0,.15);
    }

    .status{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:999px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      font-weight:700;
      font-size:13px;
      white-space:nowrap;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background:var(--warn);
      box-shadow:0 0 0 4px rgba(245,158,11,.18);
    }
    .dot.ok{ background:var(--ok); box-shadow:0 0 0 4px rgba(22,163,74,.18); }
    .dot.bad{ background:var(--bad); box-shadow:0 0 0 4px rgba(239,68,68,.18); }

    main{ padding: 18px 20px 34px; }
    .tab-content{ display:none; }
    .tab-content.active{ display:block; }

    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap:16px;
      align-items:stretch;
    }
    .grid-2{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:16px;
    }
    @media (max-width: 900px){
      .grid-2{ grid-template-columns: 1fr; }
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:20px;
    }

    .card-header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:16px;
    }

    .title{ font-weight:900; font-size:15px; letter-spacing:.2px; }
    .sub{ color:var(--muted); font-size:12px; margin-top:4px; line-height:1.35; }

    .big{
      display:flex;
      align-items:baseline;
      gap:10px;
      margin-top:8px;
    }
    .big .value{
      font-size:54px;
      font-weight:950;
      letter-spacing:-1px;
      line-height:1;
    }
    .big .unit{
      font-size:14px;
      color:var(--muted);
      font-weight:800;
    }

    .stats-grid {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap:12px;
      margin-top:12px;
    }

    .stat{
      border:1px solid var(--border);
      border-radius:12px;
      padding:14px;
      background:#fafafa;
    }
    .stat .label{ font-size:11px; color:var(--muted); font-weight:800; margin-bottom:6px; text-transform:uppercase; letter-spacing:.3px; }
    .stat .value{ font-weight:950; font-size:24px; letter-spacing:-.5px; }
    .stat .unit{ font-size:12px; color:var(--muted); margin-left:4px; }

    .pill{
      padding:6px 12px;
      border-radius:999px;
      font-size:11px;
      font-weight:900;
      border:1px solid var(--border);
      background:#f8fafc;
      color:#111827;
      white-space:nowrap;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .pill.quiet{ background:rgba(22,163,74,.10); border-color:rgba(22,163,74,.25); color:#15803d; }
    .pill.normal{ background:rgba(59,130,246,.10); border-color:rgba(59,130,246,.25); color:#1d4ed8; }
    .pill.moderate{ background:rgba(245,158,11,.12); border-color:rgba(245,158,11,.28); color:#b45309; }
    .pill.loud{ background:rgba(239,68,68,.10); border-color:rgba(239,68,68,.25); color:#dc2626; }
    .pill.concerning{ background:rgba(220,38,38,.15); border-color:rgba(220,38,38,.3); color:#991b1b; }

    .summary-section {
      background:#f8fafc;
      border:1px solid var(--border);
      border-radius:12px;
      padding:16px;
      margin-top:12px;
    }
    .summary-section h3 {
      margin:0 0 12px 0;
      font-size:13px;
      font-weight:900;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.4px;
    }
    .summary-section p {
      margin:8px 0;
      line-height:1.6;
      font-size:14px;
    }

    table {
      width:100%;
      border-collapse:collapse;
      margin-top:12px;
      font-size:13px;
    }
    th {
      background:#f1f5f9;
      padding:10px 12px;
      text-align:left;
      font-weight:900;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.3px;
      color:var(--muted);
      border-bottom:2px solid var(--border);
    }
    td {
      padding:12px;
      border-bottom:1px solid #f1f5f9;
    }
    tr:hover td {
      background:#fafafa;
    }

    .btn{
      cursor:pointer;
      border:1px solid var(--border);
      background:#111827;
      color:#fff;
      font-weight:900;
      font-size:12px;
      padding:10px 16px;
      border-radius:12px;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .btn:hover{ background:#1f2937; }
    .btn:active{ transform:translateY(1px); }
    .btn.secondary{
      background:#fff;
      color:#111827;
    }
    .btn.secondary:hover{ background:#f8fafc; }

    .loading {
      display:inline-block;
      width:14px;
      height:14px;
      border:2px solid #f3f4f6;
      border-top-color:#111827;
      border-radius:50%;
      animation:spin 0.6s linear infinite;
    }
    @keyframes spin {
      to { transform:rotate(360deg); }
    }

    .alert {
      padding:12px 16px;
      border-radius:12px;
      margin-top:12px;
      font-size:13px;
      line-height:1.5;
    }
    .alert.info {
      background:rgba(59,130,246,.10);
      border:1px solid rgba(59,130,246,.25);
      color:#1e40af;
    }
    .alert.warn {
      background:rgba(245,158,11,.10);
      border:1px solid rgba(245,158,11,.25);
      color:#b45309;
    }

    .empty-state {
      text-align:center;
      padding:40px 20px;
      color:var(--muted);
    }

    code {
      font-family:var(--mono);
      font-size:11px;
      background:#f1f5f9;
      padding:2px 6px;
      border-radius:6px;
      border:1px solid #e2e8f0;
    }

    pre{
      margin:0;
      padding:12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#0b1220;
      color:#e5e7eb;
      font-size:12px;
      overflow:auto;
      max-height:320px;
      white-space:pre-wrap;
      word-break:break-word;
      font-family: var(--mono);
    }

    svg{ width:100%; height:300px; display:block; }

    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin-top:12px;
      padding-top:12px;
      border-top:1px dashed var(--border);
    }

    label{
      font-size:12px;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:700;
    }
    input[type="checkbox"]{ transform: translateY(1px); }
    input[type="range"]{ width:180px; accent-color:#111827; }

    .mono {
      font-family:var(--mono);
      font-size:12px;
    }

    .toggle-switch {
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 14px;
      border-radius:999px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      font-weight:700;
      font-size:12px;
      white-space:nowrap;
    }
    .toggle-switch input[type="checkbox"] {
      appearance:none;
      width:44px;
      height:24px;
      background:rgba(255,255,255,.2);
      border-radius:999px;
      position:relative;
      cursor:pointer;
      transition:all .3s;
      border:1px solid rgba(255,255,255,.3);
    }
    .toggle-switch input[type="checkbox"]:checked {
      background:var(--ok);
    }
    .toggle-switch input[type="checkbox"]::before {
      content:'';
      position:absolute;
      width:18px;
      height:18px;
      background:#fff;
      border-radius:50%;
      top:2px;
      left:2px;
      transition:all .3s;
      box-shadow:0 2px 4px rgba(0,0,0,.2);
    }
    .toggle-switch input[type="checkbox"]:checked::before {
      left:22px;
    }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="topbar">
        <div class="brand">
          <h1>üéµ SoundSense</h1>
          <p>ML-Powered Sound Monitoring with Real-time Analytics & FHIR Integration</p>
        </div>

        <div class="tabs">
          <button class="tab active" data-tab="live">üìä Live Stream</button>
          <button class="tab" data-tab="analysis">ü§ñ AI Analysis</button>
          <button class="tab" data-tab="data">üìã Data</button>
        </div>

        <div class="toggle-switch">
          <span>üé≤ Mock Data</span>
          <input type="checkbox" id="mockToggle" />
        </div>

        <div class="status">
          <span id="dot" class="dot"></span>
          <span id="statusText">Connecting‚Ä¶</span>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap">
      <!-- Live Stream Tab -->
      <div id="tab-live" class="tab-content active">
        <div class="grid-2">
          <section class="card">
            <div class="card-header">
              <div>
                <div class="title">üî¥ Current Sound Level</div>
                <div class="sub">Real-time updates from WebSocket stream</div>
              </div>
              <div id="levelPill" class="pill">‚Äî</div>
            </div>

            <div class="big">
              <div id="current" class="value">‚Äî</div>
              <div class="unit">AU</div>
            </div>

            <div class="stats-grid">
              <div class="stat">
                <div class="label">Min (60s)</div>
                <div class="value" id="min60">‚Äî</div>
              </div>
              <div class="stat">
                <div class="label">Max (60s)</div>
                <div class="value" id="max60">‚Äî</div>
              </div>
              <div class="stat">
                <div class="label">Avg (60s)</div>
                <div class="value" id="avg60">‚Äî</div>
              </div>
            </div>

            <div class="controls">
              <label>
                <input type="checkbox" id="autoZoom" checked />
                Auto-zoom
              </label>
              <label>
                Padding
                <input type="range" id="pad" min="2" max="40" value="8" />
                <span id="padVal">8</span>
              </label>
            </div>
          </section>

          <section class="card">
            <div class="card-header">
              <div>
                <div class="title">üìÑ Last FHIR Observation</div>
                <div class="sub">Most recent WebSocket message</div>
              </div>
            </div>
            <pre id="last">Waiting for data‚Ä¶</pre>
          </section>
        </div>

        <section class="card" style="margin-top:16px;">
          <div class="card-header">
            <div>
              <div class="title">üìà Live Chart (Last 60 Samples)</div>
              <div class="sub">Real-time visualization with D3.js</div>
            </div>
          </div>
          <svg id="chart" aria-label="Sound chart"></svg>
        </section>
      </div>

      <!-- AI Analysis Tab -->
      <div id="tab-analysis" class="tab-content">
        <section class="card">
          <div class="card-header">
            <div>
              <div class="title">ü§ñ AI-Generated Analysis</div>
              <div class="sub">Machine learning insights and anomaly detection</div>
            </div>
            <button id="refreshML" class="btn secondary">
              <span id="mlLoadIcon"></span>
              Refresh Analysis
            </button>
          </div>
          <div id="mlContent">
            <div class="alert info">
              Click "Refresh Analysis" to get ML-powered insights from your sensor data.
            </div>
          </div>
        </section>

        <section class="card" style="margin-top:16px;">
          <div class="card-header">
            <div>
              <div class="title">üìä Database Statistics</div>
              <div class="sub">Overall system metrics from PostgreSQL</div>
            </div>
            <button id="refreshStats" class="btn secondary">
              <span id="statsLoadIcon"></span>
              Refresh Stats
            </button>
          </div>

          <div class="stats-grid" id="statsGrid">
            <div class="stat">
              <div class="label">Total Readings</div>
              <div class="value" id="totalReadings">‚Äî</div>
            </div>
            <div class="stat">
              <div class="label">Unique Patients</div>
              <div class="value" id="uniquePatients">‚Äî</div>
            </div>
            <div class="stat">
              <div class="label">Unique Devices</div>
              <div class="value" id="uniqueDevices">‚Äî</div>
            </div>
            <div class="stat">
              <div class="label">Avg Sound Level</div>
              <div class="value" id="avgValue">‚Äî</div>
              <span class="unit">AU</span>
            </div>
            <div class="stat">
              <div class="label">Min Recorded</div>
              <div class="value" id="minValue">‚Äî</div>
              <span class="unit">AU</span>
            </div>
            <div class="stat">
              <div class="label">Max Recorded</div>
              <div class="value" id="maxValue">‚Äî</div>
              <span class="unit">AU</span>
            </div>
          </div>

          <div id="statsAlert"></div>
        </section>
      </div>

      <!-- Data Tab -->
      <div id="tab-data" class="tab-content">
        <section class="card">
          <div class="card-header">
            <div>
              <div class="title">üìã Recent Observations</div>
              <div class="sub">Last 20 FHIR observations from the database</div>
            </div>
            <button id="refreshTable" class="btn secondary">
              <span id="tableLoadIcon"></span>
              Refresh Data
            </button>
          </div>

          <div id="tableContent">
            <div class="alert info">
              Click "Refresh Data" to load recent sensor readings.
            </div>
          </div>
        </section>
      </div>
    </div>
  </main>

<script>
  const BACKEND = `http://${location.hostname || 'localhost'}:8080`;
  const ML_SERVICE = `http://${location.hostname || 'localhost'}:8000`;

  // Tab switching
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      const tabName = tab.dataset.tab;
      
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      tab.classList.add('active');
      document.getElementById(`tab-${tabName}`).classList.add('active');

      // Auto-load data when switching tabs
      if (tabName === 'analysis' && !window.statsLoaded) {
        loadStats();
        window.statsLoaded = true;
      } else if (tabName === 'data' && !window.tableLoaded) {
        loadTable();
        window.tableLoaded = true;
      }
    });
  });

  // JWT Token Management
  let authToken = localStorage.getItem('jwt_token');

  async function login() {
    try {
      const response = await fetch(`${BACKEND}/auth/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: 'admin', password: 'admin123' })
      });
      
      if (response.ok) {
        const data = await response.json();
        authToken = data.token;
        localStorage.setItem('jwt_token', authToken);
        return true;
      }
    } catch (error) {
      console.error('Login failed:', error);
    }
    return false;
  }

  async function fetchWithAuth(url, options = {}) {
    if (!authToken) await login();

    const headers = { ...options.headers, 'Authorization': `Bearer ${authToken}` };
    let response = await fetch(url, { ...options, headers });

    if (response.status === 401) {
      await login();
      headers.Authorization = `Bearer ${authToken}`;
      response = await fetch(url, { ...options, headers });
    }

    return response;
  }

  // ============================================
  // LIVE STREAM TAB
  // ============================================

  const statusText = document.getElementById("statusText");
  const dot = document.getElementById("dot");
  const currentEl = document.getElementById("current");
  const lastEl = document.getElementById("last");
  const levelPill = document.getElementById("levelPill");
  const min60El = document.getElementById("min60");
  const max60El = document.getElementById("max60");
  const avg60El = document.getElementById("avg60");
  const autoZoomEl = document.getElementById("autoZoom");
  const padEl = document.getElementById("pad");
  const padValEl = document.getElementById("padVal");

  padEl.addEventListener("input", () => { padValEl.textContent = padEl.value; render(); });
  autoZoomEl.addEventListener("change", render);

  const data = [];
  const maxN = 60;

  function setStatus(state){
    if(state === "ok"){
      statusText.textContent = "Connected ‚úÖ";
      dot.className = "dot ok";
    } else if(state === "bad"){
      statusText.textContent = "Disconnected";
      dot.className = "dot bad";
    } else {
      statusText.textContent = "Connecting‚Ä¶";
      dot.className = "dot";
    }
  }

  function updateKpis(){
    if(data.length === 0) return;
    const vals = data.map(d => d.value);
    min60El.textContent = Math.min(...vals).toFixed(0);
    max60El.textContent = Math.max(...vals).toFixed(0);
    avg60El.textContent = (vals.reduce((a,b)=>a+b,0) / vals.length).toFixed(1);
  }

  function updateLevelPill(v){
    levelPill.className = "pill";
    if(v < 187){
      levelPill.textContent = "Quiet";
      levelPill.classList.add("quiet");
    } else if(v < 300){
      levelPill.textContent = "Normal";
      levelPill.classList.add("normal");
    } else if(v < 500){
      levelPill.textContent = "Moderate";
      levelPill.classList.add("moderate");
    } else if(v < 700){
      levelPill.textContent = "Loud";
      levelPill.classList.add("loud");
    } else {
      levelPill.textContent = "Concerning";
      levelPill.classList.add("concerning");
    }
  }

  // Chart setup
  const svg = d3.select("#chart");
  const margin = { top: 18, right: 18, bottom: 34, left: 56 };

  const rootG = svg.append("g");
  const xAxisG = rootG.append("g");
  const yAxisG = rootG.append("g");
  const gridG  = rootG.append("g").attr("opacity", 0.25);
  const linePath = rootG.append("path")
    .attr("fill", "none")
    .attr("stroke", "#111827")
    .attr("stroke-width", 2.5);
  const dotsG = rootG.append("g");

  function render(){
    const node = svg.node();
    const width = node.clientWidth || 900;
    const height = 300;

    const innerW = width - margin.left - margin.right;
    const innerH = height - margin.top - margin.bottom;

    rootG.attr("transform", `translate(${margin.left},${margin.top})`);

    const x = d3.scaleLinear()
      .domain([0, Math.max(1, data.length - 1)])
      .range([0, innerW]);

    let yMin = 0, yMax = 1;

    if(data.length > 0){
      const vals = data.map(d => d.value);
      const minV = d3.min(vals);
      const maxV = d3.max(vals);

      if(autoZoomEl.checked){
        const pad = Number(padEl.value);
        yMin = (minV ?? 0) - pad;
        yMax = (maxV ?? 1) + pad;
      } else {
        yMin = 0;
        yMax = 800;
      }
    }

    if(yMax - yMin < 1){ yMin -= 1; yMax += 1; }

    const y = d3.scaleLinear().domain([yMin, yMax]).nice().range([innerH, 0]);

    xAxisG.attr("transform", `translate(0,${innerH})`).call(d3.axisBottom(x).ticks(6).tickSizeOuter(0));
    yAxisG.call(d3.axisLeft(y).ticks(6).tickSizeOuter(0));

    gridG.selectAll("*").remove();
    gridG.selectAll("line").data(y.ticks(6)).enter().append("line")
      .attr("x1", 0).attr("x2", innerW)
      .attr("y1", d => y(d)).attr("y2", d => y(d))
      .attr("stroke", "#111827");

    const line = d3.line().x((d,i) => x(i)).y(d => y(d.value)).curve(d3.curveMonotoneX);
    linePath.datum(data).attr("d", line);

    const dots = dotsG.selectAll("circle").data(data, (d,i)=>i);
    dots.exit().remove();
    dots.enter().append("circle").attr("r", 3).attr("fill", "#111827").attr("opacity", 0.75)
      .merge(dots).attr("cx", (d,i) => x(i)).attr("cy", d => y(d.value));
  }

  window.addEventListener("resize", render);

  // ============================================
  // MOCK DATA GENERATOR
  // ============================================

  let mockInterval = null;
  let mockEnabled = false;
  let mockPatternIndex = 0;

  // Realistic sound patterns: quiet hours, normal activity, loud events
  const mockPatterns = [
    { min: 50, max: 150, trend: 0.2, noise: 20 },     // Quiet (night/empty)
    { min: 150, max: 300, trend: 0.5, noise: 40 },   // Normal (ambient)
    { min: 250, max: 450, trend: 1.0, noise: 60 },   // Active (conversation)
    { min: 400, max: 650, trend: 1.5, noise: 80 },   // Loud (music/events)
    { min: 600, max: 850, trend: 2.0, noise: 100 },  // Very loud (alarm/emergency)
  ];

  function generateMockObservation() {
    // Cycle through patterns every 15 readings
    if (Math.random() < 0.05) {
      mockPatternIndex = (mockPatternIndex + 1) % mockPatterns.length;
    }

    const pattern = mockPatterns[mockPatternIndex];
    
    // Generate value with trend and noise
    const base = pattern.min + Math.random() * (pattern.max - pattern.min);
    const trend = Math.sin(Date.now() / 5000) * pattern.trend * 30;
    const noise = (Math.random() - 0.5) * pattern.noise;
    const value = Math.max(0, Math.min(1000, base + trend + noise));

    // Create SensorReading matching backend format
    return {
      value: Math.round(value * 10) / 10,
      unit: "AU",
      code: "SOUND_LEVEL",
      patient_id: `Patient/mock-patient-${Math.floor(Math.random() * 3) + 1}`,
      device_id: `Device/mock-sensor-${Math.floor(Math.random() * 2) + 1}`,
      ts: new Date().toISOString()
    };
  }

  function startMockData() {
    if (mockInterval) return;
    
    console.log('üé≤ Mock data generator started');
    setStatus("ok");
    
    // Generate data every 1-3 seconds (like real sensor)
    const generateData = async () => {
      if (!mockEnabled) return;
      
      const obs = generateMockObservation();
      const v = obs.value;
      
      currentEl.textContent = v.toFixed(0);
      updateLevelPill(v);
      lastEl.textContent = JSON.stringify(obs, null, 2);
      
      data.push({ value: v, ts: Date.now() });
      if (data.length > maxN) data.shift();
      
      updateKpis();
      render();
      
      // Send to backend database (like real sensor does)
      try {
        await fetch(`${BACKEND}/ingest`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(obs)
        });
      } catch (error) {
        console.warn('Failed to send mock data to backend:', error.message);
      }
      
      // Random interval between 1-3 seconds
      const nextInterval = 1000 + Math.random() * 2000;
      mockInterval = setTimeout(generateData, nextInterval);
    };
    
    generateData();
  }

  function stopMockData() {
    if (mockInterval) {
      clearTimeout(mockInterval);
      mockInterval = null;
      console.log('üé≤ Mock data generator stopped');
    }
  }

  // WebSocket connection
  let ws = null;
  const WS_URL = `ws://${location.hostname || 'localhost'}:8080/ws/live`;

  function connect(){
    if (mockEnabled) {
      console.log('Mock mode enabled, skipping WebSocket connection');
      return;
    }
    
    setStatus("connecting");
    try{ if(ws){ ws.close(); ws = null; } }catch(_){}

    ws = new WebSocket(WS_URL);
    ws.onopen = () => setStatus("ok");
    ws.onclose = () => { 
      if (!mockEnabled) {
        setStatus("bad"); 
        setTimeout(connect, 2000);
      }
    };
    ws.onerror = () => {
      if (!mockEnabled) setStatus("bad");
    };

    ws.onmessage = (ev) => {
      try{
        const obs = JSON.parse(ev.data);
        const v = obs?.valueQuantity?.value;

        if(typeof v === "number"){
          currentEl.textContent = v.toFixed(0);
          updateLevelPill(v);
          lastEl.textContent = JSON.stringify(obs, null, 2);

          data.push({ value: v, ts: Date.now() });
          if(data.length > maxN) data.shift();

          updateKpis();
          render();
        }
      }catch(_){}
    };
  }

  // Mock data toggle
  const mockToggle = document.getElementById('mockToggle');
  mockToggle.addEventListener('change', (e) => {
    mockEnabled = e.target.checked;
    
    if (mockEnabled) {
      // Switch to mock mode
      if (ws) {
        ws.close();
        ws = null;
      }
      stopMockData();
      startMockData();
    } else {
      // Switch to real WebSocket mode
      stopMockData();
      data.length = 0;
      currentEl.textContent = '‚Äî';
      lastEl.textContent = 'Waiting for data‚Ä¶';
      levelPill.textContent = '‚Äî';
      min60El.textContent = '‚Äî';
      max60El.textContent = '‚Äî';
      avg60El.textContent = '‚Äî';
      render();
      connect();
    }
  });

  connect();
  render();

  // ============================================
  // AI ANALYSIS TAB
  // ============================================

  async function loadMLAnalysis() {
    const btn = document.getElementById('refreshML');
    const icon = document.getElementById('mlLoadIcon');
    const content = document.getElementById('mlContent');

    icon.className = 'loading';
    btn.disabled = true;

    try {
      const response = await fetch(`${ML_SERVICE}/analysis`);
      if (!response.ok) throw new Error('ML service unavailable');

      const data = await response.json();
      
      // Check if we have analysis data
      if (!data.success || !data.analysis || data.analysis.total_readings === 0) {
        content.innerHTML = `<div class="empty-state"><p>No data available for analysis. Please ensure sensor readings are being collected.</p></div>`;
        return;
      }
      
      const analysis = data.analysis;
      let html = '';

      // Overall Summary
      html += `<div class="summary-section">
        <h3>üìà Overall Summary</h3>
        <p><strong>Total Samples:</strong> ${analysis.total_readings || 0}</p>
        <p><strong>Average Level:</strong> ${(analysis.avg_level || 0).toFixed(1)} AU</p>
        <p><strong>Standard Deviation:</strong> ${(analysis.std_level || 0).toFixed(1)} AU</p>
        <p><strong>Range:</strong> ${(analysis.min_level || 0).toFixed(1)} - ${(analysis.max_level || 0).toFixed(1)} AU</p>
      </div>`;

      // Time-based patterns
      if (analysis.peak_hour !== undefined) {
        html += `<div class="summary-section">
          <h3>‚è∞ Time Patterns</h3>
          <p><strong>Peak Activity Hour:</strong> ${analysis.peak_hour}:00</p>
          <p><strong>Quietest Hour:</strong> ${analysis.quietest_hour}:00</p>
        </div>`;
      }

      // Sound Classifications
      if (analysis.category_distribution) {
        html += `<div class="summary-section">
          <h3>üéØ Sound Classifications</h3>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">`;
        
        const total = analysis.total_readings;
        for (const [category, count] of Object.entries(analysis.category_distribution)) {
          const percentage = ((count / total) * 100).toFixed(1);
          const className = category.toLowerCase().replace(' ', '-');
          html += `<span class="pill ${className}">${category}: ${count} (${percentage}%)</span>`;
        }
        html += `</div></div>`;
      }

      // Anomalies
      if (analysis.anomaly_count !== undefined && analysis.anomaly_count > 0) {
        html += `<div class="alert warn">
          <strong>‚ö†Ô∏è Anomalies Detected:</strong> ${analysis.anomaly_count} unusual readings (${analysis.anomaly_percentage.toFixed(1)}% of total)
        </div>`;
      } else if (analysis.anomaly_count === 0) {
        html += `<div class="alert info">
          <strong>‚úì No Anomalies:</strong> All readings appear normal
        </div>`;
      }

      content.innerHTML = html;

    } catch (error) {
      console.error('ML Analysis error:', error);
      content.innerHTML = `<div class="alert warn"><strong>Error:</strong> ${error.message}. Make sure the ML service is running and database has data.</div>`;
    } finally {
      icon.className = '';
      btn.disabled = false;
    }
  }

  async function loadStats() {
    const btn = document.getElementById('refreshStats');
    const icon = document.getElementById('statsLoadIcon');
    const alert = document.getElementById('statsAlert');

    icon.className = 'loading';
    btn.disabled = true;
    alert.innerHTML = '';

    try {
      const response = await fetch(`${ML_SERVICE}/stats`);
      if (!response.ok) throw new Error('Failed to load statistics');

      const data = await response.json();
      document.getElementById('totalReadings').textContent = data.total_readings || 0;
      document.getElementById('uniquePatients').textContent = data.unique_patients || 0;
      document.getElementById('uniqueDevices').textContent = data.unique_devices || 0;
      document.getElementById('avgValue').textContent = (data.avg_value || 0).toFixed(1);
      document.getElementById('minValue').textContent = (data.min_value || 0).toFixed(0);
      document.getElementById('maxValue').textContent = (data.max_value || 0).toFixed(0);

    } catch (error) {
      alert.innerHTML = `<div class="alert warn"><strong>Error:</strong> ${error.message}</div>`;
    } finally {
      icon.className = '';
      btn.disabled = false;
    }
  }

  // ============================================
  // DATA TAB
  // ============================================

  async function loadTable() {
    const btn = document.getElementById('refreshTable');
    const icon = document.getElementById('tableLoadIcon');
    const content = document.getElementById('tableContent');

    icon.className = 'loading';
    btn.disabled = true;

    try {
      const response = await fetchWithAuth(`${BACKEND}/api/fhir/Observation?limit=20`);
      if (!response.ok) throw new Error(`HTTP ${response.status}`);

      const bundle = await response.json();
      const entries = bundle.entry || [];

      if (entries.length === 0) {
        content.innerHTML = `<div class="empty-state"><p>No observations found.</p></div>`;
        return;
      }

      let html = `<table><thead><tr>
        <th>Timestamp</th>
        <th>Patient ID</th>
        <th>Device ID</th>
        <th>Value</th>
        <th>Classification</th>
      </tr></thead><tbody>`;

      entries.forEach(entry => {
        const obs = entry.resource;
        const time = new Date(obs.effectiveDateTime).toLocaleString();
        const patientId = obs.subject?.reference?.split('/')[1] || 'N/A';
        const deviceId = obs.device?.reference?.split('/')[1] || 'N/A';
        const value = obs.valueQuantity?.value || 0;
        const unit = obs.valueQuantity?.unit || 'AU';

        let classification = 'normal', classText = 'Normal';
        if (value < 187) { classification = 'quiet'; classText = 'Quiet'; }
        else if (value >= 300 && value < 500) { classification = 'moderate'; classText = 'Moderate'; }
        else if (value >= 500 && value < 700) { classification = 'loud'; classText = 'Loud'; }
        else if (value >= 700) { classification = 'concerning'; classText = 'Concerning'; }

        html += `<tr>
          <td class="mono">${time}</td>
          <td class="mono">${patientId}</td>
          <td class="mono">${deviceId}</td>
          <td><strong>${value.toFixed(1)}</strong> ${unit}</td>
          <td><span class="pill ${classification}">${classText}</span></td>
        </tr>`;
      });

      html += `</tbody></table>`;
      content.innerHTML = html;

    } catch (error) {
      content.innerHTML = `<div class="alert warn"><strong>Error:</strong> ${error.message}</div>`;
    } finally {
      icon.className = '';
      btn.disabled = false;
    }
  }

  document.getElementById('refreshML').addEventListener('click', loadMLAnalysis);
  document.getElementById('refreshStats').addEventListener('click', loadStats);
  document.getElementById('refreshTable').addEventListener('click', loadTable);
</script>
</body>
</html>
